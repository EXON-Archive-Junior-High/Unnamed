import Head from 'next/head'
import { Fragment, useEffect, useRef, useState } from 'react'
import laftel from 'laftel.js'
import axios from 'axios'
import { useDrag } from 'react-use-gesture'
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome'
import { faArrowLeft, faArrowRight, faXmark } from '@fortawesome/free-solid-svg-icons'

import CardImg from '../assets/card.jpg'

import Nav from './nav'
import Loading from './loading'

export default function Home({ daily, images }: any) {

  // const [xy, setXY] = useState({x: 0, y: 0})
  // const bindLogoPos = useDrag((params)=>{
  //   setXY({
  //     x: params.offset[0]+window.innerWidth/2.5,
  //     y: params.offset[1]+window.innerHeight/2.5,
  //   })
  // })

  const [selectedInfo, setSelectedInfo] = useState({
    id: '',
    name: '',
    img: '',
    content: '',
    distribute: '',
    year_quarter: '',
    age: '',
    genres: []
  })

  const [open , setOpen] = useState(false)
  let PropTitle: string = ""

  const [week, setWeek] = useState('')
  const [Load, setLoad] = useState(true)
  const [windowLoad, setWindowLoad] = useState(true)
  const horizontalScrollRef = useRef<null | any>(null)

  const handleNextButtonClick = (nextType: 'prev' | 'next') => {
    if (!horizontalScrollRef.current) return;
      if (nextType === 'prev') {
        horizontalScrollRef.current.scrollTo({
          left: horizontalScrollRef.current.scrollLeft - horizontalScrollRef.current.offsetWidth,
          behavior: 'smooth',
        })
      } else {
        horizontalScrollRef.current.scrollTo({
          left: horizontalScrollRef.current.scrollLeft + horizontalScrollRef.current.offsetWidth,
          behavior: 'smooth',
        })
      }
  }

  const getInfo = async () => {
    setTimeout(()=>{
      setWindowLoad(false)
    }, 1000)

    const res = await fetch(`http://localhost:3000/api/info?name=${PropTitle}`, {
      method: 'GET',
      headers: {
        "Content-Type": "application/json",
      },
    })
    const data = await res.json()
    console.log(data)

    let genres_temp = []
    for (let i = 0; i < 4; i++) {
      genres_temp.push(data.anime.main_tag[i].name)
    }

    setSelectedInfo({
      id: data.id,
      name: data.anime.name,
      img: data.anime.img,
      content: data.anime.content,
      distribute: data.anime.animation_info.distributed_air_time,
      year_quarter: data.anime.animation_info.air_year_quarter,
      age: data.anime.content_rating,
      genres: genres_temp
    })
  }

  useEffect(() => {
    const day = new Date()
    const WeekDay = ['일', '월', '화', '수', '목', '금', '토']
    setWeek(WeekDay[day.getDay()])

    setTimeout(()=>{
      setLoad(false)
    }, 1000)

    // setXY({ x: window.innerWidth/2.5, y: window.innerHeight/2.5 })
  }, [])

  return (
    Load ? <Loading /> :
    <Fragment>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      { open && window.innerWidth > 500 ?
        <div className="window-contain">
          <div>  {/* style={{ position: 'fixed', left: xy.x, top: xy.y }} */}
            <div className="title-window">  {/* { ...bindLogoPos() } */}
              <div className="window-title">{ selectedInfo.name }</div>
              <div className="window-btns">
                <button className='info-in-btn' onClick={() => { setOpen(false); setWindowLoad(true) }}><FontAwesomeIcon className='window-btn' icon={faXmark} /></button>
              </div>
            </div>
            <div className="info-window">
              { windowLoad ?
                <div className="loading-window">
                  <svg className='spinner whitelogo' xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
                </div>
              :
                <Fragment>
                  <div className="main-info">
                    <img className='info-img' src={ selectedInfo.img } alt="" />
                    <div className="">
                      <div className="info-title">{ selectedInfo.name }</div>
                      <div className="tags-info">
                        { selectedInfo.genres.map((el: any, idx: number) => (
                          <div className="tag">#{el}</div>
                        )) }
                      </div>
                      <div className="lighter">방영 요일: <strong>{ selectedInfo.distribute }</strong></div>
                      <div className="lighter">출시 구분: <strong>{ selectedInfo.year_quarter }</strong></div>
                      <div className="lighter">장르: <strong>{ selectedInfo.genres[0] } · { selectedInfo.genres[1] }</strong></div>
                      <button className='play' onClick={ () => window.open(`https://laftel.net/item/${selectedInfo.id}`) }>
                        <div className="laftel-logo"></div>
                        <div className="play-text">보러가기</div>
                      </button>
                    </div>
                  </div>
                  <div className="info-content">{ selectedInfo.content }</div>
                </Fragment>
              }
            </div>
          </div>

        </div>
      : null }

      <Nav />

      <main>
        {/* <nav className='nav'> */}
          {/* <div className="nav-title">Navbar</div>
          <button className="btn">로그인</button> */}
        {/* </nav> */}
        <div className="bg"></div>

        <div className="bg-info">
          <div className="bg-info-text">이번 분기의 <span className='colored'>인기</span> 애니를 확인해보세요</div>
          <button className="btn">확인하러 가기</button>
        </div>

        <div className="cards">

          <div className="tests">
            <div className="card-sub">
              <div className="bg-info-text">오늘(<span className='colored colored-2'>{week}</span>요일) 신작 애니</div>
            </div>
            {/* <button className="change-btn">표시 변경</button> */}
          </div>

          <div className="card-contain-contain">
            <button className='prev' onClick={ () => handleNextButtonClick('prev') }>
              <FontAwesomeIcon icon={faArrowLeft} />
            </button>
            <div className="card-contain" ref={horizontalScrollRef}>
                { daily.map((el: any, idx: number) => (
                  <button className="card" onClick={ () => { console.log(el.title); PropTitle = el.title; getInfo(); setOpen(true) } }>
                    <img className='card-img' src={ images[idx] || CardImg } />
                    <div className="text-contain">
                      <div className="card-title">{ el.title }</div>
                    </div>
                  </button>
                )) }
            </div>
            <button className='next' onClick={ () => handleNextButtonClick('next') }>
            <FontAwesomeIcon icon={faArrowRight} />
            </button>
          </div>
        </div>

      </main>
    </Fragment>
  )
}

export async function getStaticProps() {
  const res = await fetch('http://localhost:3000/api/daily', {
    method: 'GET',
    headers: {
        "Content-Type": "application/json",
    },
  })
  const data = await res.json()

  return { props: { daily: data.data, images: data.images } }
}